<!DOCTYPE html>
<html lang="en">
    <head>
        <title>3D Transformations</title>
        <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
                <link rel="stylesheet" href="themes/test.min.css" />
                <link rel="stylesheet" href="themes/jquery.mobile.icons.min.css" />
                <link rel="stylesheet" href="jquery/jquery.mobile.structure-1.4.5.min.css" />
                <script src="jquery/jquery-1.11.1.min.js"></script>
                <script src="jquery/jquery.mobile-1.4.5.min.js"></script>
				 <style>
                    body {
                        margin: 0px;
                        background-color: #000000;
                        overflow: hidden;
                    }
                </style>
                </head>
    <body>

        <script src="three.min.js"></script>
		<script src="js/OrbitControls.js"></script>
    <script src="js/loaders/OBJLoader.js"></script>

		<a href="#popupBasic" id="popupbutton" data-rel="popup">Transform 3D</a>

		<div data-role="popup" id="popupBasic" data-dismissible="false" data-theme="b" style="z-index: 3000;   position: absolute; padding: 10px 20px 10px 10px;width:360px; background-color: rgba(202, 202, 202, 0.75);background: rgba(202, 202, 202, 0.75);" data-position-to="#popupbutton">
			<a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-left">Close</a>
			<h3>Transform 3D</h3>
			<h4>Input</h4>
            <div id="main">
                <form>
                    <textarea  id="matrix" >
[1, 0, 0, 0],
[0, 1, 0, 0],
[0, 0, 1, 0],
[0, 0, 0, 1]
                        </textarea>
                    <button type="button" id="applyButton" onclick="applyMatrix()" >Apply Matrix!</button>
                    <button type="button" id="resetButton" onclick="resetMatrix()" >Reset Matrix!</button>
					<h4>Output</h4>

                    <textarea id="completematrix">




					</textarea>
                </form>
            </div>

        </div>




        <script>

            var camera, scene, renderer;
            var mesh;
			var group;
			var controls;

			var targetRotation = 0;
			var targetRotationOnMouseDown = 0;

			var mouseX = 0;
			var mouseXOnMouseDown = 0;

			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;
            init();
            animate();
            function init() {
                camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 1000 );
                camera.position.z = 4;
                camera.position.y = 2;
                camera.position.x = 0;

                scene = new THREE.Scene();
				group = new THREE.Group();
        // Create a red cylinder for the x axis
  var xMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
  var xGeometry = new THREE.CylinderGeometry(0.05, 0.05, 5, 32);
  var xAxis = new THREE.Mesh(xGeometry, xMaterial);
  xAxis.rotation.z = -Math.PI / 2;
  xAxis.position.x = 2.5;
  group.add(xAxis);

  // Add label for x-axis
  var xLabel = createLabel("X", xMaterial);
  xLabel.position.x = 3;
  xLabel.position.y = -0.5;
  group.add(xLabel);
// Create a green cylinder for the y axis
var yMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
var yGeometry = new THREE.CylinderGeometry(0.05, 0.05, 5, 32);
var yAxis = new THREE.Mesh(yGeometry, yMaterial);
yAxis.position.y = 2.5;
group.add(yAxis);

// Add label for y-axis
var yLabel = createLabel("Y", yMaterial);
yLabel.position.x = -0.5;
yLabel.position.y = 3;
group.add(yLabel);

// Create a blue cylinder for the z axis
var zMaterial = new THREE.MeshBasicMaterial({ color: 0x0000ff });
var zGeometry = new THREE.CylinderGeometry(0.05, 0.05, 5, 32);
var zAxis = new THREE.Mesh(zGeometry, zMaterial);
zAxis.rotation.x = Math.PI / 2;
zAxis.position.z = 2.5;
group.add(zAxis);

// Add label for z-axis
var zLabel = createLabel("Z", zMaterial);
zLabel.position.z = 3;
zLabel.position.y = -0.5;
group.add(zLabel);


        function createLabel(text, material) {
    var canvas = document.createElement("canvas");
    canvas.width = 256;
    canvas.height = 256;
    var context = canvas.getContext("2d");
    context.font = "Bold 48px Arial";
    context.fillStyle = "#" + material.color.getHexString();
    context.textAlign = "center";
    context.fillText(text, canvas.width / 2, canvas.height / 2);
    var texture = new THREE.Texture(canvas);
    texture.needsUpdate = true;
    var material = new THREE.SpriteMaterial({ map: texture, color: 0xffffff });
    var sprite = new THREE.Sprite(material);
    sprite.scale.set(0.5, 0.5, 0.5);
    return sprite;
}

				var gridHelper = new THREE.GridHelper( 10, 20 );
				gridHelper.translateOnAxis(new THREE.Vector3(1,1,1), 0.01);
				group.add( gridHelper );
				var axisHelper = new THREE.AxisHelper( 5 );
        //axisHelper.material.linewidth = 2; // Set the width of the axis helper
                group.add( axisHelper );

                group.position.y = 0;
        group.position.z = 0;
        scene.background = new THREE.Color(0xffffff); // Set the scene background to white

        scene.add(group);

        var loader = new THREE.OBJLoader();

        // Load the teapot.obj file
        loader.load(
            'teapot.obj',
            function (object) {
              var material = new THREE.MeshPhongMaterial({
          color: 0x808080,
          specular: 0xffffff,
          shininess: 100
      });
                object.traverse(function (child) {
                    if (child instanceof THREE.Mesh) {
                        child.material = material;
                    }
                });
                mesh = object;
                group.add(object);
                camera.lookAt(object.position);
            },
            function (xhr) {
                console.log((xhr.loaded / xhr.total * 100) + '% loaded');
            },
            function (error) {
                console.log('An error happened');
            }
        );

        // Add a directional light
var light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(1, 1, 1);
scene.add(light);

        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);

				//document.addEventListener( 'mousedown', onDocumentMouseDown, false );
				//document.addEventListener( 'touchstart', onDocumentTouchStart, false );
				//document.addEventListener( 'touchmove', onDocumentTouchMove, false );

				//

                window.addEventListener( 'resize', onWindowResize, false );
            }
        function applyMatrix() {
			var inputMat = "[ " + $('#matrix').val() + " ]";
			if(IsJsonStringValid(inputMat)){
				m1 = JSON.parse( inputMat);

				if(m1.length==4&&m1[0].length==4){

			// m1 = JSON.parse($('#matrix').val());
            var m = new THREE.Matrix4();

            m.set(m1[0][0],m1[0][1],m1[0][2],m1[0][3],
                  m1[1][0],m1[1][1],m1[1][2],m1[1][3],
                  m1[2][0],m1[2][1],m1[2][2],m1[2][3],
                  m1[3][0],m1[3][1],m1[3][2],m1[3][3]);
                  mesh.applyMatrix( m);
				  var completemat =mesh.matrix.elements;
				  printMatrix(completemat);

                  console.log( m1);
				}
				else{
					alert("wrong matrix format");
				}
			}
			else{
				alert("wrong matrix format");
			}

        }
		function IsJsonStringValid(str) {
			var maxLen = 1000;
			if (maxLen && str.length > maxLen)
			return false;
			else{
				try {
					JSON.parse(str);
				} catch (e) {
					return false;
				}
				return true;
			}
		}
        function resetMatrix() {

			mesh.position.set( 0, 0, 0 );
			mesh.rotation.set( 0, 0, 0 );
			mesh.scale.set( 1, 1, 1 );
			mesh.updateMatrix();

			var message ="";
			var completemat =mesh.matrix.elements;
			printMatrix(completemat);

        }

		function printMatrix(completemat){
			var message ="";
			for (var i = 0; i < 4; i++){
				for (var j = 0; j < 4; j++){
					var index = i + j*4;
					message+=completemat[index].toFixed(4) + ", ";
				}
				message+="\n";
			}
			document.getElementById('completematrix').value = message;		}

		function onDocumentMouseDown( event ) {

			//event.preventDefault();

			document.addEventListener( 'mousemove', onDocumentMouseMove, false );
			document.addEventListener( 'mouseup', onDocumentMouseUp, false );
			document.addEventListener( 'mouseout', onDocumentMouseOut, false );

			mouseXOnMouseDown = event.clientX - windowHalfX;
			targetRotationOnMouseDown = targetRotation;

		}

		function onDocumentMouseMove( event ) {

			mouseX = event.clientX - windowHalfX;

			targetRotation = targetRotationOnMouseDown + ( mouseX - mouseXOnMouseDown ) * 0.02;

		}

		function onDocumentMouseUp( event ) {

			document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
			document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
			document.removeEventListener( 'mouseout', onDocumentMouseOut, false );

		}

		function onDocumentMouseOut( event ) {

			document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
			document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
			document.removeEventListener( 'mouseout', onDocumentMouseOut, false );

		}

		function onDocumentTouchStart( event ) {

			if ( event.touches.length == 1 ) {

				event.preventDefault();

				mouseXOnMouseDown = event.touches[ 0 ].pageX - windowHalfX;
				targetRotationOnMouseDown = targetRotation;

			}

		}

		function onDocumentTouchMove( event ) {

			if ( event.touches.length == 1 ) {

				event.preventDefault();

				mouseX = event.touches[ 0 ].pageX - windowHalfX;
				targetRotation = targetRotationOnMouseDown + ( mouseX - mouseXOnMouseDown ) * 0.05;

			}

		}

	    function PopUp(){
			$( "#popupBasic" ).popup( "open" )
			controls.noPan = true;
		}
		$(document).ready(function(){
						  setTimeout(function(){
									 PopUp()
									 },1000); // 5000 to load it after 5 seconds from page load
		$("#popupBasic").bind({popupafterclose: function(event,ui){
					controls.noPan = false;
					}
				});
		$("#popupBasic").bind({popupafteropen: function(event, ui){
					controls.noPan = true;
					}
					});

  });
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize( window.innerWidth, window.innerHeight );
        }
        function animate() {
			controls.update();
            requestAnimationFrame( animate );
            renderer.render( scene, camera );
        }
        </script>

    </body>
</html>
