<!DOCTYPE html>
<html lang="en">
    <head>
        <title>3D Transformations</title>
        <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
                <link rel="stylesheet" href="themes/test.min.css" />
                <link rel="stylesheet" href="themes/jquery.mobile.icons.min.css" />
                <link rel="stylesheet" href="jquery/jquery.mobile.structure-1.4.5.min.css" />
                <script src="jquery/jquery-1.11.1.min.js"></script>
                <script src="jquery/jquery.mobile-1.4.5.min.js"></script>
				 <style>
                    body {
                        margin: 0px;
                        background-color: #000000;
                        overflow: hidden;
                    }
                </style>
                </head>
    <body>
        
        <script src="three.min.js"></script>
		<script src="js/OrbitControls.js"></script>
		
		<a href="#popupBasic" id="popupbutton" data-rel="popup">Transform 3D</a>
		
		<div data-role="popup" id="popupBasic" data-dismissible="false" data-theme="b" style="z-index: 3000;   position: absolute; padding: 10px 20px 10px 10px;width:360px; background-color: rgba(202, 202, 202, 0.75);background: rgba(202, 202, 202, 0.75);" data-position-to="#popupbutton">
			<a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-left">Close</a>
			<h3>Transform 3D</h3>
			<h4>Input</h4>
            <div id="main">
                <form>
                    <textarea  id="matrix" >
[1, 0, 0, 0],
[0, 1, 0, 0],
[0, 0, 1, 0],
[0, 0, 0, 1]
                        </textarea>
                    <button type="button" id="applyButton" onclick="applyMatrix()" >Apply Matrix!</button>
                    <button type="button" id="resetButton" onclick="resetMatrix()" >Reset Matrix!</button>
					<h4>Output</h4>
					
                    <textarea id="completematrix">
					
					
					
					
					</textarea>
                </form>
            </div>

        </div>
        
        

        
        <script>
           
            var camera, scene, renderer;
            var mesh;
			var group;
			var controls;
			
			var targetRotation = 0;
			var targetRotationOnMouseDown = 0;
			
			var mouseX = 0;
			var mouseXOnMouseDown = 0;
			
			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;
            init();
            animate();
            function init() {
                camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 1000 );
                camera.position.z = 4;
                camera.position.y = 2;
                camera.position.x = 0;
                
                scene = new THREE.Scene();
				group = new THREE.Group();
				var axisHelper = new THREE.AxisHelper( 100 );
				group.add( axisHelper );
				
				group.position.y = 0;
				group.position.z = 0;
				scene.add( group );
                var texture = new THREE.TextureLoader().load( 'crate.gif' );
                var geometry = new THREE.BoxBufferGeometry( 1, 1, 1 );
                var material = new THREE.MeshBasicMaterial( { map: texture } );
                mesh = new THREE.Mesh( geometry, material );
                group.add( mesh );
                camera.lookAt( mesh.position );
                
                //mesh.geometry.applyMatrix( new THREE.Matrix4().setPosition( -10,-22,-30 ) );
                var m = new THREE.Matrix4();
                
                m.set( 1, 0, 0, 0,
                      0, 1, 0, 0,
                     0, 0, 1, 0,
                     0, 0, 0, 1);
                     mesh.geometry.applyMatrix( m );

                renderer = new THREE.WebGLRenderer();
                renderer.setPixelRatio( window.devicePixelRatio );
                renderer.setSize( window.innerWidth, window.innerHeight );
                document.body.appendChild( renderer.domElement );
                //
				
				controls = new THREE.OrbitControls(camera, renderer.domElement);
				
				//document.addEventListener( 'mousedown', onDocumentMouseDown, false );
				//document.addEventListener( 'touchstart', onDocumentTouchStart, false );
				//document.addEventListener( 'touchmove', onDocumentTouchMove, false );
				
				//
				
                window.addEventListener( 'resize', onWindowResize, false );
            }
        function applyMatrix() {
			var inputMat = "[ " + $('#matrix').val() + " ]";
			if(IsJsonStringValid(inputMat)){
				m1 = JSON.parse( inputMat);
				
				if(m1.length==4&&m1[0].length==4){

			// m1 = JSON.parse($('#matrix').val());
            var m = new THREE.Matrix4();
            
            m.set(m1[0][0],m1[0][1],m1[0][2],m1[0][3],
                  m1[1][0],m1[1][1],m1[1][2],m1[1][3],
                  m1[2][0],m1[2][1],m1[2][2],m1[2][3],
                  m1[3][0],m1[3][1],m1[3][2],m1[3][3]);
                  mesh.applyMatrix( m);
				  var completemat =mesh.matrix.elements;
				  printMatrix(completemat);
				  
                  console.log( m1);
				}
				else{
					alert("wrong matrix format");
				}
			}
			else{
				alert("wrong matrix format");
			}

        }
		function IsJsonStringValid(str) {
			var maxLen = 1000;
			if (maxLen && str.length > maxLen)
			return false;
			else{
				try {
					JSON.parse(str);
				} catch (e) {
					return false;
				}
				return true;
			}
		}
        function resetMatrix() {
			
			mesh.position.set( 0, 0, 0 );
			mesh.rotation.set( 0, 0, 0 );
			mesh.scale.set( 1, 1, 1 );
			mesh.updateMatrix();
			
			var message ="";
			var completemat =mesh.matrix.elements;
			printMatrix(completemat);
			
        }
		
		function printMatrix(completemat){
			var message ="";
			for (var i = 0; i < 4; i++){
				for (var j = 0; j < 4; j++){
					var index = i + j*4;
					message+=completemat[index].toFixed(4) + ", ";
				}
				message+="\n";
			}
			document.getElementById('completematrix').value = message;		}
		
		function onDocumentMouseDown( event ) {
			
			//event.preventDefault();
			
			document.addEventListener( 'mousemove', onDocumentMouseMove, false );
			document.addEventListener( 'mouseup', onDocumentMouseUp, false );
			document.addEventListener( 'mouseout', onDocumentMouseOut, false );
			
			mouseXOnMouseDown = event.clientX - windowHalfX;
			targetRotationOnMouseDown = targetRotation;
			
		}
		
		function onDocumentMouseMove( event ) {
			
			mouseX = event.clientX - windowHalfX;
			
			targetRotation = targetRotationOnMouseDown + ( mouseX - mouseXOnMouseDown ) * 0.02;
			
		}
		
		function onDocumentMouseUp( event ) {
			
			document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
			document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
			document.removeEventListener( 'mouseout', onDocumentMouseOut, false );
			
		}
		
		function onDocumentMouseOut( event ) {
			
			document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
			document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
			document.removeEventListener( 'mouseout', onDocumentMouseOut, false );
			
		}
		
		function onDocumentTouchStart( event ) {
			
			if ( event.touches.length == 1 ) {
				
				event.preventDefault();
				
				mouseXOnMouseDown = event.touches[ 0 ].pageX - windowHalfX;
				targetRotationOnMouseDown = targetRotation;
				
			}
			
		}
		
		function onDocumentTouchMove( event ) {
			
			if ( event.touches.length == 1 ) {
				
				event.preventDefault();
				
				mouseX = event.touches[ 0 ].pageX - windowHalfX;
				targetRotation = targetRotationOnMouseDown + ( mouseX - mouseXOnMouseDown ) * 0.05;
				
			}
			
		}
		
	    function PopUp(){
			$( "#popupBasic" ).popup( "open" )
			controls.noPan = true;
		}
		$(document).ready(function(){
						  setTimeout(function(){
									 PopUp()
									 },1000); // 5000 to load it after 5 seconds from page load
		$("#popupBasic").bind({popupafterclose: function(event,ui){
					controls.noPan = false;
					}
				});
		$("#popupBasic").bind({popupafteropen: function(event, ui){
					controls.noPan = true;
					}
					});						

  });
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize( window.innerWidth, window.innerHeight );
        }
        function animate() {
			controls.update();
            requestAnimationFrame( animate );
            renderer.render( scene, camera );
        }
        </script>
        
    </body>
</html>
